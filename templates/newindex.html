<!doctype html>
<html lang="en">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
/>
<link rel="stylesheet" href="../static/style.css" />
<meta charset="utf-8">
<title>Scuffed Tier List</title>
<style>
  body {
    background:#181818;
    font-family: sans-serif;
    margin:0; padding:2rem;
  }

  .panel {
    background:#202020;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.4);
    max-width:530px;
    transition:max-height .4s ease, opacity .4s ease;
    flex: 0.85; /* Flex-grow ratio */
  }

  .panel-header {
    background:#2b2b2b;
    padding:12px 16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .panel-header h2 {
    margin:0;
    font-size:1.2rem;
    color:#4CAF50;
  }
  .panel-header button {
    background:none;
    border:none;
    color:#aaa;
    font-size:1.2rem;
    cursor:pointer;
  }

  .panel-content {
    padding:16px;
  }
  .panel-content p {
    margin-top:0;
    font-size:.9rem;
    color:#ccc;
  }

  /* Tabs */
  .tabs {
    display:flex;
    gap:4px;
    margin-top:12px;
  }
  .tab {
    flex:1;
    padding:8px;
    border-radius:6px;
    background:#333;
    color:#ccc;
    cursor:pointer;
    text-align:center;
    font-size:.9rem;
  }
  .tab.active {
    background:#4CAF50;
    color:#000;
    font-weight:bold;
  }

  .tab-panel {
    display:none;
    margin-top:12px;
    padding:10px;
    background:#2b2b2b;
    color: white;
    border-radius:6px;
  }
  .tab-panel.active {
    display:block;
  }
      html, body {
        height: 100%;
        margin: 0;
      }

      body {
        display: flex;
        flex-direction: column;
      }

      .navbar {
        background-color: #333;
        color: #fff;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .scroll-container {

        border: 0px solid;
        scrollbar-color: #000000;
        padding: 10px;
        box-sizing: border-box; /* Ensures padding is included in width */
        overflow-y: auto; /* Allows vertical scrolling */
      }

.main-container {
        display: flex;
        gap: 20px; /* Optional: add space between the elements */
        flex: 1; /* Allows .main to take up the remaining space */
        align-items: flex-start; /* Ensures items are aligned at the top */
}

#retractable {
  flex-grow: 2;        /* takes twice as much space */
  min-width: 200px;
  border: 0px solid #ccc;
}

.tiers.container {
  flex: 2;       /* 1 part */
  min-width: 150px;
  border: 0px solid #0c0;
}

.game-title-container {
  flex: 0.5; /* Flex-grow ratio */      /* 1 part */
  min-width: 150px;
  border: 0px solid #00c;
}



      .searchbar {
        display: flex;
        width: 100%;       /* make it fill the tab */
        gap: 6px;
        margin: 12px 0;
        }

        .searchbar input {
        flex: 1;           /* let input take all available space */
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #fff;  /* white like in your screenshot */
        color: #000;
        font-size: .9rem;
        }

        .searchbar button {
        padding: 0 16px;
        border: none;
        border-radius: 6px;
        background: #4CAF50;  /* green background like your image */
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        }
        .searchbar button:hover {
        background: #45a049;
        }

        .container {
            width: 100%;
            padding: 0;
            margin: 0;

        }
            .options-panel {
      width: 300px;
      padding: 10px;
      background: #1e1e1e;
    }

  .option-group {
    display: flex;
    align-items: center;
    justify-content: space-between; /* pushes dropdown to the right */
    margin-bottom: 10px;
  }

  .option-label {
    font-size: 14px;
    margin-right: 10px;
    white-space: nowrap;
  }

  select {
    background: #dcdcdc;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
  }

    input[type="color"] {
      width: 40px;
      height: 40px;
      padding: 0;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
    }

    hr {
      border: none;
      border-top: 1px solid #444;
      margin: 10px 0;
    }
    .chart-btn {
      background-color: #2c2c2c;
      color: white;
      border: none;
      padding: 20px;
      width: 160px;
      height: 80px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .chart-btn:hover {
      background-color: #3a3a3a;
    }
    

.playtime-modal {
  background: #2b2b2b;
  border: none;
  border-radius: 8px;
  padding: 20px;
  color: white;
  max-width: 300px;
}
.playtime-modal input {
  width: 60px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #111;
  color: white;
}
.playtime-modal button {
  padding: 6px 12px;
  border-radius: 4px;
  border: none;
  cursor: pointer;
}
.playtime-modal button#savePlaytime {
  background: #4CAF50;
  color: black;
}
.playtime-modal button#cancelPlaytime {
  background: #666;
  color: white;
}


#rouletteResult {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-height: 80vh; /* or whatever height you want */
  overflow: hidden;
}

#rouletteResult img {
  width: 100% !important;
  max-height: 100%;  /* scale down if too tall */
  object-fit: contain; /* fit image inside both width & height */
  aspect-ratio: 1 !important;
  display: block;
  cursor: default;
}

#tab4 button#roulette {
  margin-left: 0px !important;
  width: 100%;           /* fill the full width of the parent container */
  padding: 12px 20px;    /* adjust padding for nice height */
  font-size: 1.1rem;     /* optional, make text readable */
  box-sizing: border-box; /* ensures padding doesn’t break width */
  cursor: pointer;
}

</style>
    <script type="module" src="../static/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>    
<div class="main-container">
  <!-- Panel -->
  <div class="panel" id="retractable">
    <div class="panel-header">
      <h2>Scuffed Tier List</h2>
      <button id="toggleBtn">▼</button>
    </div>
    <div class="panel-content">
      <p>Never Complete. Never Public. Always Scuffed.</p>
      <div class="tabs">
        <div class="tab active" data-tab="tab1">Game Search</div>
        <div class="tab" data-tab="tab2">Options</div>
        <div class="tab" data-tab="tab3">Save/Load</div>
        <div class="tab" data-tab="tab4">The Roulette</div>
      </div>
      
      <div class="tab-panel active" id="tab1">
        <form id="inputForm" class="input-form">
          <div class="searchbar">
            <input type="text" id="searchbar" name="searchbar" placeholder="Search for game" required>
            <button type="submit">🔎</button>
          </div>
          <p id="response"></p>
        </form>
        <div id="scroll-container" class="scroll-container"></div>
      </div>
      
      <div class="tab-panel" id="tab2">
        <div class="option-group">
          <label class="option-label" for="quality">Quality:</label>
          <select name="quality" id="quality">
            <option value="1">Potato</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
          </select>
        </div>

        <hr>

        <div class="option-group">
          <label class="option-label" for="showTextToggle">Display Game Titles:</label>
          <select name="showTextToggle" id="showTextToggle">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>

        <hr>
        
        <div class="option-group">
          <label class="option-label" for="showPlaytimeToggle">Show Playtimes:</label>
          <select name="showPlaytimeToggle" id="showPlaytimeToggle">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div class="tab-panel" id="tab3">
        <div style="display: flex; gap: 10px;">
          <button id="saveButton" class="chart-btn">
            Save
          </button>
          <label for="loadButton" class="chart-btn">
            Load
          </label>
          <input type="file" id="loadButton" accept=".json" style="display: none;">
          <button id="saveAsPngButton" class="chart-btn">
            Render as PNG
          </button>
        </div>
      </div>
      
      <div class="tab-panel" id="tab4">
        <button id="roulette">Choose Random Game</button>
        <div id="rouletteResult">
          <img class="resultImage" id="resultImage" src="" alt="Roulette Result" style="display:none;">
        </div>
      </div>
    
    </div>
  </div>


  <!-- Tiers container -->
  <div class="tiers container"></div>

  <!-- Game title container -->
  <div class="game-title-container"></div>
</div>


<dialog class="settings-modal">
      <section>
        <div class="colors"></div>

        <textarea class="tier-label" placeholder="Tier label"></textarea>

        <button id="delete">Delete Row</button>
        <button id="clear">Clear Row</button>
        <button id="prepend">Add a Row Above</button>
        <button id="append">Add a Row Below</button>
      </section>
    </dialog>

    <div id="imageContainer"></div>


<dialog class="playtime-modal">
  <section>
    <h3 style="margin:0 0 10px; color:white;">Edit Playtime</h3>
    <div style="display:flex; gap:10px; margin-bottom:10px; color:white;">
      <label>H: <input type="number" id="playtimeHours" min="0" value="0"></label>
      <label>M: <input type="number" id="playtimeMinutes" min="0" max="59" value="0"></label>
      <label>S: <input type="number" id="playtimeSeconds" min="0" max="59" value="0"></label>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="cancelPlaytime">Cancel</button>
      <button id="savePlaytime">Save</button>
    </div>
  </section>
</dialog>


<script>
  const panel = document.getElementById('retractable');
  const toggleBtn = document.getElementById('toggleBtn');
  const content = panel.querySelector('.panel-content');
  let collapsed = false;

  
  toggleBtn.addEventListener('click', () => {
    collapsed = !collapsed;
    if (collapsed) {
      content.style.display = 'none';
      toggleBtn.textContent = '▲';
    } else {
      content.style.display = 'block';
      toggleBtn.textContent = '▼';
    }
  });

  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });



document.getElementById('inputForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this);

    fetch('/submit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('response').innerText = data.response;

        const imageContainer = document.querySelector('.scroll-container');
        imageContainer.innerHTML = '';

        if (data.boxarts) {
            data.boxarts.forEach(([url, title]) => {
                const proxyUrl = `/proxy?url=${encodeURIComponent(url)}`;
                const imgElement = document.createElement('img');
                imgElement.src = proxyUrl;
                imgElement.alt = title;
                imgElement.draggable = true;
                imgElement.style.margin = '5px';
                imgElement.addEventListener('dragstart', handleDragStart);
                imgElement.addEventListener('dragend', handleDragEnd);
                imgElement.addEventListener('dblclick', handleImageRemove);
                imageContainer.appendChild(imgElement);
            });
        }
    })
    .catch(error => console.error('Error:', error));
});

document.getElementById('searchbar').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent the default behavior
        document.getElementById('inputForm').dispatchEvent(new Event('submit')); // Trigger the submit event
    }
});

function handleDragStart(event) {
    event.dataTransfer.setData('text/plain', event.target.src);
    event.target.classList.add('dragging');
}

function handleDragEnd(event) {
    event.target.classList.remove('dragging');
}

function handleDragover(event) {
    event.preventDefault(); // Allow drop
}

function handleDrop(event) {
    event.preventDefault(); // Prevent default browser handling

    const draggedImage = document.querySelector('.dragging');
    if (!draggedImage) {
        console.error('No image is being dragged.');
        return;
    }

    const target = event.target;
    if (target.classList.contains("items")) {
        target.appendChild(draggedImage);
        updateAltTextColorAndOrder();
    } else if (target.tagName === "IMG" && target !== draggedImage) {
        const { left, width } = target.getBoundingClientRect();
        const midPoint = left + width / 2;

        if (event.clientX < midPoint) {
            target.before(draggedImage);
        } else {
            target.after(draggedImage);
        }
        updateAltTextColorAndOrder();
    }
}

function handleImageRemove(event) {
    // Remove the image from the tier
    const image = event.target;
    image.remove();

    // Update the alt text in the game-title-container
    updateAltTextColorAndOrder();
}

function updateAltTextColorAndOrder() {
  const gameTitleContainer = document.querySelector('.game-title-container');
  gameTitleContainer.style.overflow = 'visible';
  gameTitleContainer.innerHTML = ''; // Clear existing titles

  let totalSeconds = 0;

  const tiers = document.querySelectorAll('.tier');
  tiers.forEach(tier => {
    const labelEl = tier.querySelector('.label');
    const tierColor = window.getComputedStyle(labelEl).getPropertyValue('--color').trim();
    const images = tier.querySelectorAll('.items img');

    if (images.length > 0) {
      images.forEach(image => {
        // Row wrapper
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.justifyContent = 'space-between';
        wrapper.style.gap = '6px';
        wrapper.style.margin = '0';
        wrapper.style.lineHeight = '1.1';
        wrapper.style.padding = '2px 0 4px 0'; // extra space at bottom


        // Title element
        const titleElement = document.createElement('p');
        titleElement.textContent = image.alt || '';
        titleElement.style.color = tierColor;
        titleElement.contentEditable = true;
        titleElement.style.flex = '1 1 auto';
        titleElement.style.margin = '0';
        titleElement.style.overflow = 'hidden';
        titleElement.style.textOverflow = 'ellipsis';
        titleElement.style.whiteSpace = 'nowrap';
        titleElement.style.lineHeight = '1.1';

        // Ensure dataset exists
        if (!image.dataset.hours) image.dataset.hours = "0";
        if (!image.dataset.minutes) image.dataset.minutes = "0";
        if (!image.dataset.seconds) image.dataset.seconds = "0";

        // Playtime text
        const timeDisplay = document.createElement('span');
        timeDisplay.style.color = tierColor;
        timeDisplay.style.fontWeight = 'bold';
        timeDisplay.textContent = formatSeconds(
          parseTimeToSeconds(image.dataset.hours, image.dataset.minutes, image.dataset.seconds)
        );

        // Edit button
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = '⏱️';
        editBtn.style.background = 'transparent';
        editBtn.style.border = 'none';
        editBtn.style.cursor = 'pointer';
        editBtn.style.color = tierColor;
        editBtn.style.fontSize = '1rem';
        editBtn.style.marginLeft = '6px';

        editBtn.addEventListener('click', () => {
          const modal = document.querySelector('.playtime-modal');
          const hoursField = document.getElementById('playtimeHours');
          const minutesField = document.getElementById('playtimeMinutes');
          const secondsField = document.getElementById('playtimeSeconds');
          const saveBtn = document.getElementById('savePlaytime');
          const cancelBtn = document.getElementById('cancelPlaytime');

          // Pre-fill with current values
          hoursField.value = image.dataset.hours || "0";
          minutesField.value = image.dataset.minutes || "0";
          secondsField.value = image.dataset.seconds || "0";

          modal.showModal();

          const handleSave = () => {
            const h = hoursField.value || "0";
            const m = minutesField.value || "0";
            const s = secondsField.value || "0";

            image.dataset.hours = h;
            image.dataset.minutes = m;
            image.dataset.seconds = s;

            timeDisplay.textContent = formatSeconds(parseTimeToSeconds(h, m, s));
            calculateTotalPlaytime();

            modal.close();
            saveBtn.removeEventListener('click', handleSave);
            cancelBtn.removeEventListener('click', handleCancel);
          };

          const handleCancel = () => {
            modal.close();
            saveBtn.removeEventListener('click', handleSave);
            cancelBtn.removeEventListener('click', handleCancel);
          };

          saveBtn.addEventListener('click', handleSave);
          cancelBtn.addEventListener('click', handleCancel);
        });


        // Runtime wrapper
        const runtimeWrapper = document.createElement('div');
        runtimeWrapper.style.display = 'inline-flex';
        runtimeWrapper.style.alignItems = 'center';
        runtimeWrapper.append(timeDisplay, editBtn);

        // Add to row
        wrapper.appendChild(titleElement);
        wrapper.appendChild(runtimeWrapper);
        gameTitleContainer.appendChild(wrapper);

        // Add to total
        totalSeconds += parseTimeToSeconds(
          image.dataset.hours,
          image.dataset.minutes,
          image.dataset.seconds
        );
      });

      // Spacer between tiers
      gameTitleContainer.appendChild(document.createElement('br'));
    }
  });

  // Total element
  let totalElement = document.getElementById('totalPlaytime');
  if (!totalElement) {
    totalElement = document.createElement('p');
    totalElement.id = 'totalPlaytime';
    totalElement.style.color = 'green';
    totalElement.style.fontWeight = 'bold';
    totalElement.style.marginTop = '8px';
    gameTitleContainer.appendChild(totalElement);
  }
  totalElement.textContent = `Time Wasted: ${formatSeconds(totalSeconds)}`;
}

// Helper: convert runtime → seconds
function parseTimeToSeconds(h, m, s) {
  const hh = parseInt(h) || 0;
  const mm = parseInt(m) || 0;
  const ss = parseInt(s) || 0;
  return hh * 3600 + mm * 60 + ss;
}

function formatSeconds(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h}h ${String(m).padStart(2, '0')}m ${String(s).padStart(2, '0')}s`;
}

function calculateTotalPlaytime() {
  let totalSeconds = 0;
  const images = document.querySelectorAll('.tier .items img');
  images.forEach(image => {
    totalSeconds += parseTimeToSeconds(
      image.dataset.hours,
      image.dataset.minutes,
      image.dataset.seconds
    );
  });

  const totalElement = document.getElementById('totalPlaytime');
  if (totalElement) {
    totalElement.textContent = `Time Wasted: ${formatSeconds(totalSeconds)}`;
  }
}





function handleTextEdit(titleElement, image) {
    // Update the alt text of the image with the new text
    const newAltText = titleElement.textContent;
    image.alt = newAltText;
}

function makeImagesDraggable() {
    const images = document.querySelectorAll('.scroll-container img');
    images.forEach((img) => {
        img.draggable = true;
        img.addEventListener('dragstart', handleDragStart);
        img.addEventListener('dragend', handleDragEnd);
        img.addEventListener('dblclick', handleImageRemove); // Add double-click event for removal
    });
}

</script>

</body>
</html>
